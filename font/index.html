<script>

	const fontSourceName = `'GT Pressura Mono'`;
	const size = 40;

	const fontObjectName = `Monospace${size}`;

	const render = async () => {
		await document.fonts.load(`${size}px ${fontSourceName}`);

		const characters = [];

		for (let i = 'a'.charCodeAt(0); i < 'z'.charCodeAt(0) + 1; i++) {
			characters.push(
				String.fromCharCode(i),
				String.fromCharCode(i).toUpperCase()
			);
		}

		for (let i = 0; i < 10; i++) {
			characters.push(i.toString());
		}

		characters.push('-', ':', ';', ',', '.', '_');

		const canvas = document.createElement('canvas');
		document.body.appendChild(canvas);

		const context = canvas.getContext('2d');
		const font = context.font = `${size}px ${fontSourceName}`;

		const baseMeasurement = context.measureText('a');
		const height = baseMeasurement.fontBoundingBoxAscent + baseMeasurement.fontBoundingBoxDescent;
		const width = Math.max(...characters.map(character => context.measureText(character).width));

		canvas.width = width;
		canvas.height = height;

		context.font = font;

		const glyphs = [];

		for (let character of characters) {
			const metrics = context.measureText(character);
			const characterWidth = Math.floor(metrics.width);
			console.log(character, characterWidth);

			context.clearRect(0, 0, width, height);
			context.fillText(character, 0, baseMeasurement.fontBoundingBoxAscent);

			const data = context.getImageData(0, 0, characterWidth, height);

			let lastState = false;
			let length = 0;

			const segments = [];

			for (let offset = 0; offset < height * characterWidth; offset++) {
				const state = data.data[offset * 4 + 3] > 0x8f;
				length++;

				if (state != lastState) {
					lastState = state;
					segments.push(length);
					length = 0;
				}
			}

			const dataIdentifier = `glyph${character.charCodeAt(0)}${fontObjectName}Data`;

			glyphs.push({
				dataIdentifier,
				character,
				characterWidth,
				segments
			});
		}

		const definition = `#include <stdio.h>
#include "index.cpp"

// generated by /font/index.html
//
// source font: ${fontSourceName} ${size}px
//
${glyphs.map(glyph => `static const uint16_t ${glyph.dataIdentifier}[] = { ${glyph.segments.join(', ')} };`).join('\n')}

static const Glyph ${fontObjectName}Glyphs[] = {
${glyphs.map(glyph => `\t{ '${glyph.character}', ${glyph.characterWidth}, ${glyph.dataIdentifier}, ${glyph.segments.length}}`).join(',\n')}
};

static const Font ${fontObjectName} = { ${height}, ${fontObjectName}Glyphs, ${glyphs.length} };
`;

		console.log(definition);
	}

	onload = () => render();

</script>
